<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policies - CitizenVoice AI</title>
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üó≥Ô∏è CitizenVoice</h2>
                <p>Participatory Governance</p>
            </div>

            <ul class="sidebar-menu">
                <li><a href="dashboard.html">üìä Dashboard</a></li>
                <li><a href="policies.html" class="active">üìã Policies</a></li>
                <li><a href="complaints.html">üì¢ My Complaints</a></li>
                <li><a href="analytics.html">üìà Analytics</a></li>
                <li><a href="ussd-simulator.html" target="_blank">üì± USSD Simulator</a></li>
            </ul>

            <div class="sidebar-footer">
                <div class="user-info">
                    <h4 id="user-name">Loading...</h4>
                    <p id="user-district">District</p>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="topbar">
                <h1>Active Policies</h1>
                <div class="topbar-actions">
                    <select id="category-filter" style="padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;" onchange="filterPolicies()">
                        <option value="">All Categories</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Education">Education</option>
                        <option value="Infrastructure">Infrastructure</option>
                        <option value="Agriculture">Agriculture</option>
                        <option value="Economy">Economy</option>
                        <option value="Security">Security</option>
                    </select>
                </div>
            </div>

            <div class="content-area">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-value" id="total-policies">0</div>
                        <div class="stat-card-label">Active Policies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="my-feedback">0</div>
                        <div class="stat-card-label">My Feedback</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="total-feedback">0</div>
                        <div class="stat-card-label">Total Feedback</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="closing-soon">0</div>
                        <div class="stat-card-label">Closing Soon</div>
                    </div>
                </div>

                <!-- Policies Grid -->
                <div id="policies-grid" class="cards-grid">
                    <div style="grid-column: 1/-1; text-align: center; padding: 30px;">Loading policies...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; padding: 20px;">
        <div style="background: white; margin: 50px auto; padding: 40px; border-radius: 15px; max-width: 900px;">
            <h2 style="margin-bottom: 20px;" id="policy-modal-title">Policy Feedback</h2>
            
            <div id="policy-details" style="background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                Loading...
            </div>

            <!-- Existing Feedback -->
            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;">Community Feedback</h3>
                <div id="existing-feedback" style="max-height: 300px; overflow-y: auto;">
                    Loading feedback...
                </div>
            </div>

            <!-- Submit Feedback Form -->
            <div style="background: #f0f0f0; padding: 25px; border-radius: 10px;">
                <h3 style="margin-bottom: 15px;">Submit Your Feedback</h3>
                <form id="feedback-form">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Your Feedback *</label>
                        <textarea id="feedback-text" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;" rows="6" required placeholder="Share your thoughts, concerns, or suggestions about this policy..."></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Submit Feedback</button>
                        <button type="button" class="btn btn-secondary" onclick="closeFeedbackModal()" style="flex: 1;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let currentUser = null;
        let authToken = null;
        let allPolicies = [];
        let currentPolicyId = null;

        // Check authentication
        function checkAuth() {
            authToken = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');

            if (!authToken || !userStr) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userStr);
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-district').textContent = currentUser.district_name || 'District';
        }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // API call with auth
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);

            if (response.status === 401) {
                logout();
                return;
            }

            return await response.json();
        }

        // Load policies
        async function loadPolicies() {
            try {
                const policies = await apiCall('/policies/?status=Active');
                
                if (Array.isArray(policies)) {
                    allPolicies = policies;
                    
                    // Load details for each policy
                    const policiesWithDetails = await Promise.all(
                        policies.map(async policy => {
                            const details = await apiCall(`/policies/${policy.id}`);
                            return { ...policy, ...details };
                        })
                    );
                    
                    allPolicies = policiesWithDetails;
                    updateStats(policiesWithDetails);
                    displayPolicies(policiesWithDetails);
                }
            } catch (error) {
                console.error('Error loading policies:', error);
            }
        }

        // Update stats
        function updateStats(policies) {
            document.getElementById('total-policies').textContent = policies.length;
            
            let totalFeedback = 0;
            let closingSoon = 0;
            const now = new Date();
            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            policies.forEach(policy => {
                totalFeedback += policy.feedback_count || 0;
                
                if (policy.policy.deadline) {
                    const deadline = new Date(policy.policy.deadline);
                    if (deadline <= weekFromNow && deadline > now) {
                        closingSoon++;
                    }
                }
            });
            
            document.getElementById('total-feedback').textContent = totalFeedback;
            document.getElementById('closing-soon').textContent = closingSoon;
        }

        // Display policies
        function displayPolicies(policies) {
            const grid = document.getElementById('policies-grid');

            if (policies.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 30px;">No active policies available</div>';
                return;
            }

            grid.innerHTML = policies.map(policyData => {
                const policy = policyData.policy;
                const sentiment = policyData.sentiment_distribution || { positive: 0, neutral: 0, negative: 0 };
                const feedbackCount = policyData.feedback_count || 0;
                
                let deadlineText = 'Ongoing';
                let deadlineClass = '';
                
                if (policy.deadline) {
                    const deadline = new Date(policy.deadline);
                    const now = new Date();
                    const daysLeft = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                    
                    if (daysLeft < 0) {
                        deadlineText = 'Closed';
                        deadlineClass = 'style="color: #ef4444;"';
                    } else if (daysLeft <= 7) {
                        deadlineText = `${daysLeft} days left`;
                        deadlineClass = 'style="color: #f59e0b;"';
                    } else {
                        deadlineText = `${daysLeft} days left`;
                        deadlineClass = 'style="color: #10b981;"';
                    }
                }

                return `
                    <div class="card" style="cursor: pointer; transition: all 0.3s;" onclick="openFeedbackModal(${policy.id})">
                        <div style="margin-bottom: 15px;">
                            <span style="background: #667eea; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem;">
                                ${policy.category || 'General'}
                            </span>
                            ${policy.ministry_name ? `<span style="background: #764ba2; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; margin-left: 5px;">${policy.ministry_name}</span>` : ''}
                        </div>
                        
                        <h3 style="margin-bottom: 12px; font-size: 1.2rem; color: #333;">${policy.title}</h3>
                        
                        <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">
                            ${policy.description ? (policy.description.length > 200 ? policy.description.substring(0, 200) + '...' : policy.description) : 'No description available'}
                        </p>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-top: 15px; border-top: 2px solid #f0f0f0;">
                            <span style="color: #666;">üí¨ ${feedbackCount} Feedback</span>
                            <span ${deadlineClass}>üìÖ ${deadlineText}</span>
                        </div>
                        
                        <div style="display: flex; gap: 8px;">
                            <div style="flex: 1; background: #d1fae5; padding: 8px; border-radius: 5px; text-align: center;">
                                <span style="font-weight: 600; color: #065f46;">üëç ${sentiment.positive}</span>
                            </div>
                            <div style="flex: 1; background: #e5e7eb; padding: 8px; border-radius: 5px; text-align: center;">
                                <span style="font-weight: 600; color: #374151;">üòê ${sentiment.neutral}</span>
                            </div>
                            <div style="flex: 1; background: #fee2e2; padding: 8px; border-radius: 5px; text-align: center;">
                                <span style="font-weight: 600; color: #991b1b;">üëé ${sentiment.negative}</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <span style="color: #667eea; font-weight: 600;">Click to provide feedback ‚Üí</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter policies
        function filterPolicies() {
            const category = document.getElementById('category-filter').value;
            
            if (!category) {
                displayPolicies(allPolicies);
            } else {
                const filtered = allPolicies.filter(p => p.policy.category === category);
                displayPolicies(filtered);
            }
        }

        // Open feedback modal
        async function openFeedbackModal(policyId) {
            currentPolicyId = policyId;
            
            try {
                const policyData = await apiCall(`/policies/${policyId}`);
                const policy = policyData.policy;
                
                document.getElementById('policy-modal-title').textContent = policy.title;
                
                const detailsDiv = document.getElementById('policy-details');
                detailsDiv.innerHTML = `
                    <h3 style="color: #667eea; margin-bottom: 10px;">${policy.title}</h3>
                    <div style="margin-bottom: 10px;">
                        <span style="background: #667eea; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem;">
                            ${policy.category || 'General'}
                        </span>
                        ${policy.ministry_name ? `<span style="background: #764ba2; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; margin-left: 5px;">${policy.ministry_name}</span>` : ''}
                    </div>
                    <p style="line-height: 1.8; color: #333;">${policy.description || 'No description available'}</p>
                    ${policy.deadline ? `<p style="margin-top: 10px; color: #666;"><strong>Deadline:</strong> ${new Date(policy.deadline).toLocaleDateString()}</p>` : ''}
                `;
                
                // Load existing feedback
                loadExistingFeedback(policyId);
                
                document.getElementById('feedback-modal').style.display = 'block';
            } catch (error) {
                console.error('Error loading policy:', error);
            }
        }

        // Load existing feedback
        async function loadExistingFeedback(policyId) {
            const feedbackDiv = document.getElementById('existing-feedback');
            feedbackDiv.innerHTML = '<p style="text-align: center; color: #666;">Loading feedback...</p>';
            
            try {
                // Note: You'll need to create this endpoint in the backend
                // For now, we'll show a placeholder
                feedbackDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>Community feedback will be displayed here once the endpoint is implemented.</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">This will show sentiment analysis, themes, and individual feedback submissions.</p>
                    </div>
                `;
            } catch (error) {
                feedbackDiv.innerHTML = '<p style="text-align: center; color: #ef4444;">Failed to load feedback</p>';
            }
        }

        // Close feedback modal
        function closeFeedbackModal() {
            document.getElementById('feedback-modal').style.display = 'none';
            document.getElementById('feedback-form').reset();
            currentPolicyId = null;
        }

        // Submit feedback
        document.getElementById('feedback-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentPolicyId) {
                alert('No policy selected');
                return;
            }

            const feedbackText = document.getElementById('feedback-text').value;

            try {
                const result = await apiCall('/feedback/policy', 'POST', {
                    policy_id: currentPolicyId,
                    feedback_text: feedbackText
                });

                if (result) {
                    alert(`Feedback submitted successfully!\n\nSentiment: ${result.analysis.sentiment}\nThemes: ${result.analysis.themes.join(', ')}\n\nThank you for your participation!`);
                    closeFeedbackModal();
                    loadPolicies(); // Reload to update counts
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
                alert('Failed to submit feedback. Please try again.');
            }
        });

        // Initialize
        checkAuth();
        loadPolicies();

        // Check for policy ID in URL
        const urlParams = new URLSearchParams(window.location.search);
        const policyId = urlParams.get('id');
        if (policyId) {
            setTimeout(() => openFeedbackModal(parseInt(policyId)), 500);
        }
    </script>
</body>
</html>