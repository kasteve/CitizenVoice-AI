<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complaint Management - CitizenVoice AI</title>
    <link rel="stylesheet" href="../css/dashboard.css">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üó≥Ô∏è CitizenVoice</h2>
                <p>Admin Panel</p>
            </div>

            <ul class="sidebar-menu">
                <li><a href="dashboard.html">üìä Dashboard</a></li>
                <li><a href="ministries.html">üèõÔ∏è Ministries</a></li>
                <li><a href="districts.html">üìç Districts</a></li>
                <li><a href="users.html">üë• Users</a></li>
                <li><a href="policies-admin.html">üìã Policies</a></li>
                <li><a href="complaints-admin.html" class="active">üì¢ All Complaints</a></li>
                <li><a href="reports.html">üìÑ Reports</a></li>
                <li><a href="../analytics.html">üìà Analytics</a></li>
            </ul>

            <div class="sidebar-footer">
                <div class="user-info">
                    <h4 id="user-name">Loading...</h4>
                    <p id="user-role">Administrator</p>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="topbar">
                <h1>Complaint Management</h1>
                <div class="topbar-actions">
                    <select id="filter-status" style="padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;" onchange="loadComplaints()">
                        <option value="">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                </div>
            </div>

            <div class="content-area">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-value" id="total-complaints">0</div>
                        <div class="stat-card-label">Total Complaints</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="pending">0</div>
                        <div class="stat-card-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="in-progress">0</div>
                        <div class="stat-card-label">In Progress</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="resolved">0</div>
                        <div class="stat-card-label">Resolved</div>
                    </div>
                </div>

                <!-- Complaints Table -->
                <div class="card">
                    <div class="card-header">
                        <h2>All Complaints</h2>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tracking #</th>
                                    <th>Citizen</th>
                                    <th>Category</th>
                                    <th>District</th>
                                    <th>Ministry</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="complaints-list">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 30px;">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div id="complaints-pagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; padding: 20px; border-top: 2px solid #f0f0f0;">
                        <button class="btn btn-secondary" onclick="prevComplaintsPage()" id="complaints-prev-btn" disabled style="padding: 8px 16px;">¬´ Previous</button>
                        <span id="complaints-page-info" style="color: #666;">Page 1 of 1</span>
                        <button class="btn btn-secondary" onclick="nextComplaintsPage()" id="complaints-next-btn" disabled style="padding: 8px 16px;">Next ¬ª</button>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Manage Complaint Modal -->
    <div id="manage-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; padding: 20px;">
        <div style="background: white; margin: 50px auto; padding: 40px; border-radius: 15px; max-width: 700px;">
            <h2 style="margin-bottom: 20px;">Manage Complaint</h2>
            <div id="complaint-info" style="background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                Loading...
            </div>
            <form id="manage-form">
                <input type="hidden" id="complaint-id">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Assign to Ministry</label>
                    <select id="assign-ministry" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <option value="">Select ministry...</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Update Status *</label>
                    <select id="update-status" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;" required>
                        <option value="Pending">Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;" id="resolution-notes-group">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Resolution Notes</label>
                    <textarea id="resolution-notes" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;" rows="4" placeholder="Describe how the issue was resolved..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Update Complaint</button>
                    <button type="button" class="btn btn-secondary" onclick="closeManageModal()" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    const API_BASE_URL = 'http://localhost:5000/api';
    let currentUser = null;
    let authToken = null;
    let allComplaints = [];
    let filteredComplaints = [];
    let currentPage = 1;
    const itemsPerPage = 15;

    function checkAuth() {
        authToken = localStorage.getItem('token');
        const userStr = localStorage.getItem('user');
        if (!authToken || !userStr) {
            window.location.href = '../login.html';
            return;
        }
        currentUser = JSON.parse(userStr);
        if (currentUser.role_id !== 2 && currentUser.role_id !== 4) {
            alert('Access denied. Admin or Chairperson privileges required.');
            window.location.href = '../dashboard.html';
            return;
        }
        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('user-role').textContent = currentUser.role_id === 2 ? 'Administrator' : 'Chairperson';
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '../login.html';
    }

    async function apiCall(endpoint, method = 'GET', data = null) {
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            }
        };
        if (data) options.body = JSON.stringify(data);
        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
        if (response.status === 401) {
            logout();
            return;
        }
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Request failed');
        }
        return await response.json();
    }

    async function loadComplaints() {
        try {
            const response = await fetch(`${API_BASE_URL}/admin/complaints`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (!response.ok) throw new Error('Failed to load complaints');
            
            const complaints = await response.json();
            const status = document.getElementById('filter-status').value;
            
            allComplaints = complaints;
            filteredComplaints = status ? complaints.filter(c => c.status === status) : complaints;
            
            document.getElementById('total-complaints').textContent = complaints.length;
            document.getElementById('pending').textContent = complaints.filter(c => c.status === 'Pending').length;
            document.getElementById('in-progress').textContent = complaints.filter(c => c.status === 'In Progress').length;
            document.getElementById('resolved').textContent = complaints.filter(c => c.status === 'Resolved').length;
            
            currentPage = 1;
            displayComplaints();
        } catch (error) {
            console.error('Error loading complaints:', error);
        }
    }

    function displayComplaints() {
        const totalPages = Math.ceil(filteredComplaints.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const complaintsToDisplay = filteredComplaints.slice(startIndex, endIndex);
        
        const tbody = document.getElementById('complaints-list');
        if (complaintsToDisplay.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px;">No complaints found</td></tr>';
            document.getElementById('complaints-pagination').style.display = 'none';
            return;
        }
        
        tbody.innerHTML = complaintsToDisplay.map(complaint => `
            <tr>
                <td><strong>${complaint.tracking_number}</strong></td>
                <td>${complaint.citizen_name || 'N/A'}</td>
                <td>${complaint.category}</td>
                <td>${complaint.district_name || 'N/A'}</td>
                <td>${complaint.ministry_name || 'Unassigned'}</td>
                <td><span class="status-badge priority-${complaint.priority.toLowerCase()}">${complaint.priority}</span></td>
                <td><span class="status-badge status-${complaint.status.toLowerCase().replace(' ', '-')}">${complaint.status}</span></td>
                <td>${new Date(complaint.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="btn btn-secondary" style="padding: 5px 15px;" onclick="manageComplaint(${complaint.id})">Manage</button>
                </td>
            </tr>
        `).join('');
        
        // Update pagination
        document.getElementById('complaints-page-info').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('complaints-prev-btn').disabled = currentPage === 1;
        document.getElementById('complaints-next-btn').disabled = currentPage === totalPages;
        document.getElementById('complaints-pagination').style.display = 'flex';
    }

    function prevComplaintsPage() {
        if (currentPage > 1) {
            currentPage--;
            displayComplaints();
        }
    }

    function nextComplaintsPage() {
        const totalPages = Math.ceil(filteredComplaints.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            displayComplaints();
        }
    }

    async function manageComplaint(id) {
        const complaint = allComplaints.find(c => c.id === id);
        if (!complaint) return;
        
        document.getElementById('complaint-id').value = complaint.id;
        document.getElementById('update-status').value = complaint.status;
        document.getElementById('resolution-notes').value = complaint.resolution_notes || '';
        
        const infoDiv = document.getElementById('complaint-info');
        infoDiv.innerHTML = `
            <h3 style="margin-bottom: 10px;">${complaint.tracking_number}</h3>
            <p><strong>Citizen:</strong> ${complaint.citizen_name || 'N/A'}</p>
            <p><strong>Category:</strong> ${complaint.category}</p>
            <p><strong>Location:</strong> ${complaint.location || 'N/A'}</p>
            <p><strong>Description:</strong> ${complaint.description}</p>
        `;
        
        await loadMinistries();
        if (complaint.ministry_id) {
            document.getElementById('assign-ministry').value = complaint.ministry_id;
        }
        
        document.getElementById('manage-modal').style.display = 'block';
    }

    async function loadMinistries() {
        const ministries = await apiCall('/admin/ministries');
        const select = document.getElementById('assign-ministry');
        select.innerHTML = '<option value="">Select ministry...</option>';
        if (Array.isArray(ministries)) {
            ministries.forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = m.name;
                select.appendChild(option);
            });
        }
    }

    function closeManageModal() {
        document.getElementById('manage-modal').style.display = 'none';
    }

    document.getElementById('update-status').addEventListener('change', function() {
        const notesGroup = document.getElementById('resolution-notes-group');
        if (this.value === 'Resolved') {
            notesGroup.style.display = 'block';
            document.getElementById('resolution-notes').required = true;
        } else {
            notesGroup.style.display = 'none';
            document.getElementById('resolution-notes').required = false;
        }
    });

    document.getElementById('manage-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const complaintId = document.getElementById('complaint-id').value;
        const data = {
            ministry_id: document.getElementById('assign-ministry').value || null,
            status: document.getElementById('update-status').value
        };
        
        if (data.status === 'Resolved') {
            data.resolution_notes = document.getElementById('resolution-notes').value;
        }
        
        try {
            await apiCall(`/admin/complaints/${complaintId}/assign`, 'PUT', data);
            alert('Complaint updated successfully!');
            closeManageModal();
            loadComplaints();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });

    checkAuth();
    loadComplaints();
</script>

</body>
</html>